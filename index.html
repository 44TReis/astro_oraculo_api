<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Astro-Tarot Oráculo</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; max-width: 920px; margin: 0 auto; padding: 16px; }
    h1 { margin: 0 0 8px; }
    form { background: #f7f7fb; padding: 12px; border-radius: 8px; }
    label { display:block; margin-top:8px; font-weight:600; }
    input, select, button { width: 100%; padding: 8px; margin-top: 4px; }
    button { cursor: pointer; border: 0; border-radius: 6px; background: #4b0082; color: #fff; }
    button:hover { background: #370061; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .tools { display:flex; gap:8px; margin-top: 8px; flex-wrap: wrap; }
    .results { margin-top:16px; }
    .pillar { border: 1px solid #eaeaea; border-radius: 8px; padding: 12px; margin-bottom: 12px; background:#fff; }
    .muted { color:#666; font-size: 14px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; background: #111; color:#9ef; border-radius: 6px; padding:8px; overflow:auto; max-height: 300px; display:none; }
    .tag { display:inline-block; font-size:12px; padding:2px 6px; border:1px solid #ddd; border-radius:999px; margin-right:4px; margin-bottom: 4px;}
  </style>
</head>
<body>
  <h1>Generador Astro-Tarot</h1>
  <p class="muted">Ingresá tus datos para obtener la lectura completa (cartas + guiones). Si querés el JSON, activá “Mostrar JSON” o usá “Descargar JSON”.</p>

  <form id="form">
    <label>Tipo de lectura</label>
    <select id="chartType">
      <option value="daily">Tránsitos diarios</option>
      <option value="natal">Carta natal</option>
    </select>

    <div class="row">
      <div>
        <label>Fecha y hora (dd/mm/aaaa hh:mm)</label>
        <input id="datetime" placeholder="01/09/2025 15:15" />
      </div>
      <div>
        <label>Zona horaria</label>
        <input id="zone" value="America/Argentina/Buenos_Aires" />
      </div>
    </div>

    <label>Ciudad o dirección (para carta natal)</label>
    <input id="location" placeholder="Luján, Argentina" />
    <div class="row">
      <div>
        <label>Latitud</label>
        <input id="lat" placeholder="-34.5662 (o -34,5662)"/>
      </div>
      <div>
        <label>Longitud</label>
        <input id="lon" placeholder="-59.1153 (o -59,1153)"/>
      </div>
    </div>
    <button type="button" id="findCoords">Buscar coordenadas</button>

    <div class="row">
      <div>
        <label>Modo de aspectos</label>
        <select id="mode">
          <option value="condensado" selected>Condensado (7 cartas por pilar)</option>
          <option value="detallado">Detallado (todas las parejas de aspecto)</option>
        </select>
      </div>
      <div style="display:flex;align-items:end;gap:8px;">
        <button type="button" id="getReading">Obtener lectura</button>
      </div>
    </div>

    <div class="tools">
      <label class="tag"><input type="checkbox" id="toggleJson" style="margin-right:6px;">Mostrar JSON</label>
      <button type="button" id="copyAll">Copiar TODO el texto</button>
      <button type="button" id="downloadJson">Descargar JSON</button>
    </div>
  </form>

  <div id="results" class="results"></div>
  <pre id="jsonBox" class="mono"></pre>

<script>
/* ==================== UTILIDADES BÁSICAS ==================== */
function normalizeNum(v){ return parseFloat(String(v).replace(',', '.')); }

function convertDateTime(input) {
  // "dd/mm/aaaa hh:mm" -> {date:"aaaa-mm-dd", time:"hh:mm"}
  const parts = input.trim().split(' ');
  if (parts.length !== 2) return null;
  const [d,m,y] = parts[0].split('/');
  const time = parts[1];
  return { date:`${y}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`, time };
}

/* ==================== TABLAS DE CORRESPONDENCIAS ==================== */
// Signos (0=Aries,...,11=Piscis) en español
const SIGNOS = ["Aries","Tauro","Géminis","Cáncer","Leo","Virgo","Libra","Escorpio","Sagitario","Capricornio","Acuario","Piscis"];
const SIGN_EMOJI = {Aries:"♈",Tauro:"♉",Géminis:"♊",Cáncer:"♋",Leo:"♌",Virgo:"♍",Libra:"♎",Escorpio:"♏",Sagitario:"♐",Capricornio:"♑",Acuario:"♒",Piscis:"♓"};

function signForLon(lon){ const idx = Math.floor(((lon%360)+360)%360 / 30); return SIGNOS[idx]; }

const PLANETA_ES = { Sun:"Sol", Moon:"Luna", Mercury:"Mercurio", Venus:"Venus", Mars:"Marte", Jupiter:"Júpiter", Saturn:"Saturno", Uranus:"Urano", Neptune:"Neptuno", Pluto:"Plutón", Ascendant:"Ascendente", Midheaven:"Medio Cielo" };

const PLANETAS_TAROT = {
  Sun:"XIX El Sol", Moon:"XVIII La Luna", Mercury:"I El Mago", Venus:"III La Emperatriz",
  Mars:"XVI La Torre", Jupiter:"X La Rueda de la Fortuna", Saturn:"XXI El Mundo",
  Uranus:"XVII La Estrella", Neptune:"XII El Colgado", Pluto:"XIII La Muerte",
  Ascendant:"0 El Loco", Midheaven:"XXI El Mundo"
};

const SIGNOS_ARCANOS = {
  Aries:"IV El Emperador", Tauro:"V El Hierofante", Géminis:"VI Los Enamorados", Cáncer:"VII El Carro",
  Leo:"VIII La Fuerza", Virgo:"IX El Ermitaño", Libra:"XI La Justicia", Escorpio:"XIII La Muerte",
  Sagitario:"XIV La Templanza", Capricornio:"XV El Diablo", Acuario:"XVII La Estrella", Piscis:"XVIII La Luna"
};

const SIGNOS_CORTE = {
  Aries:"Rey de Bastos", Tauro:"Reina de Oros", Géminis:"Caballo de Espadas", Cáncer:"Reina de Copas",
  Leo:"Rey de Bastos", Virgo:"Caballo de Oros", Libra:"Reina de Espadas", Escorpio:"Rey de Copas",
  Sagitario:"Caballo de Bastos", Capricornio:"Rey de Oros", Acuario:"Rey de Espadas", Piscis:"Reina de Copas"
};

// As de cada casa (1..12)
const CASAS_ASES = {1:"As de Oros",2:"As de Copas",3:"As de Espadas",4:"As de Bastos",5:"As de Oros",6:"As de Copas",7:"As de Espadas",8:"As de Bastos",9:"As de Oros",10:"As de Copas",11:"As de Espadas",12:"As de Bastos"};

// 36 decanatos (0..35) -> carta menor. Para simplificar, usamos patrón tipo “N de Palo” por índice.
// Si tenés tu tabla fina, podés reemplazar esta función por una tabla literal.
function decanCardByIndex(i){
  const PALOS=["Oros","Copas","Espadas","Bastos"];
  // Mapeo simple y estable (ejemplo): valores del 2 al 10 cíclicos por palo
  const val = 2 + (i % 9);      // 2..10
  const palo = PALOS[Math.floor(i/9)]; // cada 9 índices, cambia de palo
  return `${val} de ${palo}`;
}

// offsets por aspecto para “clima”
const ASPECT_OFFSETS = { conjunction:0, opposition:180, square:90, trine:120, sextile:60 };

// decanato por longitud (0..359)
function decanIndexForLongitude(lon){ const deg = ((lon%360)+360)%360; return Math.floor(deg/10); }

// casa por igual-casas a partir del Ascendente (si existe). Si no hay Ascendente, devolvemos 1.
function casaPorLongitud(lonPlaneta, lonAsc){
  if (typeof lonAsc !== 'number' || isNaN(lonAsc)) return 1;
  const diff = ((lonPlaneta - lonAsc) % 360 + 360) % 360;
  return Math.floor(diff / 30) + 1; // 1..12
}

/* ==================== MOTOR DE LECTURA ==================== */
function buildReading(positions, aspects, modo="condensado"){
  const pilares = ["Sun","Moon","Mercury","Venus","Mars","Jupiter","Saturn","Uranus","Neptune","Pluto","Ascendant","Midheaven"];
  const ascLon = positions?.Ascendant?.lon;
  const lectura = {};
  const jsonExport = {};

  for (const key of pilares){
    const pEs = PLANETA_ES[key] || key;
    const base = PLANETAS_TAROT[key] || "Falta correspondencia en la tabla";

    const lon = positions?.[key]?.lon;
    const sign = (typeof lon === 'number') ? signForLon(lon) : null;
    const arcSigno = sign ? (SIGNOS_ARCANOS[sign] || "Falta correspondencia en la tabla") : "Falta correspondencia en la tabla";
    const corteSigno = sign ? (SIGNOS_CORTE[sign] || "Falta correspondencia en la tabla") : "Falta correspondencia en la tabla";

    // Nivel 1 – 3 cartas únicas
    const n1 = [base, arcSigno, corteSigno].filter(Boolean);

    // Nivel 2 – As de la casa + menor del decanato
    const casa = casaPorLongitud(lon, ascLon);
    const asCasa = CASAS_ASES[casa] || "As de Oros";
    const decI = (typeof lon === 'number') ? decanIndexForLongitude(lon) : 0;
    const menorDec = decanCardByIndex(decI);
    const n2 = [asCasa, menorDec];

    // Nivel 3 – Clima por aspectos (modo condensado)
    let n3 = [];
    let climaTxt = "Sin aspectos relevantes o modo condensado neutral.";
    if (Array.isArray(aspects) && aspects.length > 0){
      if (modo === "condensado"){
        let tensos = 0, armonicos = 0, conj = 0;
        for (const a of aspects){
          const type = String(a.type || a.aspect || '').toLowerCase();
          if (type.includes("square") || type.includes("cuadr")) tensos++;
          else if (type.includes("oppos") || type.includes("opos")) tensos++;
          else if (type.includes("trine") || type.includes("tríg")) armonicos++;
          else if (type.includes("sext")) armonicos++;
          else if (type.includes("conj")) conj++;
        }
        let offset = 0; let clima = "neutral";
        if (tensos > armonicos){ offset = ASPECT_OFFSETS.square; clima = "tenso"; }
        else if (armonicos > tensos){ offset = ASPECT_OFFSETS.trine; clima = "armónico"; }
        else { offset = (conj>0 ? ASPECT_OFFSETS.conjunction : ASPECT_OFFSETS.trine); clima = (conj>0 ? "de conjunción" : "armónico"); }
        const cartaObj = decanCardByIndex(Math.floor((decI + Math.floor(offset/10)) % 36));
        const cartaSub = (clima==="tenso")
          ? decanCardByIndex((decI+18)%36) // simétrico
          : decanCardByIndex(decI);
        n3 = [cartaObj, cartaSub];
        climaTxt = `Clima ${clima}. Objetiva: ${cartaObj}. Subjetiva: ${cartaSub}.`;
      } else {
        // detallado: dos cartas por cada aspecto (objetiva/subjetiva)
        const pares = [];
        for (const a of aspects){
          if (!a || !a.targets) continue;
          // si el aspecto involucra este pilar
          const inv = [a.a, a.b].includes(key) || (Array.isArray(a.targets) && a.targets.includes(key));
          if (!inv) continue;
          const type = String(a.type || a.aspect || '').toLowerCase();
          let off = 0;
          if (type.includes("conj")) off = ASPECT_OFFSETS.conjunction;
          else if (type.includes("oppos") || type.includes("opos")) off = ASPECT_OFFSETS.opposition;
          else if (type.includes("square") || type.includes("cuadr")) off = ASPECT_OFFSETS.square;
          else if (type.includes("trine") || type.includes("tríg")) off = ASPECT_OFFSETS.trine;
          else if (type.includes("sext")) off = ASPECT_OFFSETS.sextile;
          const cartaObj = decanCardByIndex((decI + Math.floor(off/10))%36);
          // subjetiva: decanato del contraparte si está, si no, simétrico
          let decSub = (decI+18)%36;
          const other = (a.a===key)?a.b:a.a;
          const lonOther = positions?.[other]?.lon;
          if (typeof lonOther === 'number') decSub = decanIndexForLongitude(lonOther);
          const cartaSub = decanCardByIndex(decSub);
          pares.push(`${type}: ${cartaObj} / ${cartaSub}`);
          n3.push(cartaObj, cartaSub);
        }
        if (pares.length) climaTxt = `Aspectos: ${pares.join(" · ")}`;
      }
    }

    // Guiones completos (pueden ajustarse al estilo que te guste)
    const signoTxt = sign ? `${SIGN_EMOJI[sign]} ${sign}` : "(signo no disponible)";
    const g1 = `Nivel 1 – Constelación: ${n1.join(", ")}. ${PLANETA_ES[key]||key} en ${signoTxt}. Esta tríada marca el tono esencial: ${base} como fuerza arquetípica, ${arcSigno} como clima del signo y ${corteSigno} como actitud. Inspiración: dejá que esta combinación te muestre dónde brilla tu energía sin forzarla.`;
    const g2 = `Nivel 2 – Cosmos: ${n2.join(", ")}. Casa ${casa} (igual-casas desde tu Ascendente) y decanato actual. Práctico: llevá esta energía a hábitos y decisiones concretas; el As indica dónde iniciar y la carta menor describe el terreno emocional/mental de hoy.`;
    const g3 = n3.length
      ? `Nivel 3 – Séptimo Sentido: ${n3.join(", ")}. ${climaTxt} Integrá lo que sentís (subjetiva) con lo que sucede (objetiva) para elegir la acción con más verdad.`
      : `Nivel 3 – Séptimo Sentido: sin aspectos relevantes hoy para ${pEs}. Respirar, observar y sostener lo aprendido de N1 y N2.`;

    lectura[key] = {
      planeta: pEs, signo: sign || "", cartas: { n1, n2, n3 },
      guiones: { n1: g1, n2: g2, n3: g3 }
    };

    jsonExport[key] = {
      planet: key, planeta_es: pEs, sign, house: casa,
      level1_cards: n1, level2_cards: n2, level3_cards: n3,
      scripts: { level1: g1, level2: g2, level3: g3 }
    };
  }

  return { lectura, jsonExport };
}

/* ==================== RENDER ==================== */
function renderReading(out){
  const { lectura, jsonExport } = out;
  const results = document.getElementById('results');
  results.innerHTML = '';
  for (const key of Object.keys(lectura)){
    const p = lectura[key];
    const div = document.createElement('div');
    div.className = 'pillar';
    div.innerHTML = `
      <h2>${p.planeta}</h2>
      <div class="muted">${p.signo ? 'Signo: ' + p.signo : ''}</div>
      <h3>Nivel 1 – Constelación (3 cartas)</h3>
      <p><strong>${p.cartas.n1.join(', ')}</strong></p>
      <p>${p.guiones.n1}</p>
      <h3>Nivel 2 – Cosmos (2 cartas nuevas)</h3>
      <p><strong>${p.cartas.n2.join(', ')}</strong></p>
      <p>${p.guiones.n2}</p>
      <h3>Nivel 3 – Séptimo Sentido</h3>
      <p><strong>${p.cartas.n3.length ? p.cartas.n3.join(', ') : '—'}</strong></p>
      <p>${p.guiones.n3}</p>
    `;
    results.appendChild(div);
  }
  // JSON box
  const jb = document.getElementById('jsonBox');
  if (document.getElementById('toggleJson').checked){
    jb.textContent = JSON.stringify(jsonExport, null, 2);
    jb.style.display = 'block';
  } else {
    jb.style.display = 'none';
    jb.textContent = '';
  }

  // Copiar TODO
  document.getElementById('copyAll').onclick = () => {
    const texts = [];
    for (const k of Object.keys(lectura)){
      const p = lectura[k];
      texts.push(`${p.planeta}\nN1: ${p.guiones.n1}\nN2: ${p.guiones.n2}\nN3: ${p.guiones.n3}\n`);
    }
    navigator.clipboard.writeText(texts.join('\n')).then(()=>alert('Texto copiado.'));
  };

  // Descargar JSON
  document.getElementById('downloadJson').onclick = () => {
    const blob = new Blob([JSON.stringify(jsonExport, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.download = 'lectura_astro_tarot.json';
    a.href = url; a.click(); URL.revokeObjectURL(url);
  };
}

/* ==================== FETCH DE DATOS + BOTONES ==================== */
async function fetchCoords() {
  const loc = document.getElementById('location').value.trim();
  if (!loc) return alert('Escribí una ciudad o dirección.');
  const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(loc)}&format=json&limit=1`;
  const res = await fetch(url);
  const data = await res.json();
  if (!data?.length) return alert('No se encontraron coordenadas.');
  document.getElementById('lat').value = parseFloat(data[0].lat).toFixed(4);
  document.getElementById('lon').value = parseFloat(data[0].lon).toFixed(4);
}

async function getReading() {
  const chartType = document.getElementById('chartType').value;
  const dt = convertDateTime(document.getElementById('datetime').value);
  if (!dt) return alert('Formato de fecha/hora inválido. Usá dd/mm/aaaa hh:mm');
  const zone = document.getElementById('zone').value || 'UTC';
  const mode = document.getElementById('mode').value;

  let positions = {}, aspects = [];

  try{
    if (chartType === 'natal'){
      const lat = normalizeNum(document.getElementById('lat').value);
      const lon = normalizeNum(document.getElementById('lon').value);
      if (Number.isNaN(lat) || Number.isNaN(lon)) return alert('Lat/Lon inválidos. Usá punto o coma.');
      const url = `https://astro-oraculo-api.onrender.com/natal?date=${dt.date}&time=${dt.time}&zone=${encodeURIComponent(zone)}&lat=${lat}&lon=${lon}`;
      const r = await fetch(url); const d = await r.json();
      positions = d.positions || {}; aspects = d.aspects || [];
    } else {
      const url = `https://astro-oraculo-api.onrender.com/transits/daily?date=${dt.date}&time=${dt.time}&zone=${encodeURIComponent(zone)}`;
      const r = await fetch(url); const d = await r.json();
      positions = d.positions || {}; aspects = d.aspects || [];
    }
  } catch(e){
    return alert('Error al pedir datos astrológicos. Probá de nuevo en 1 minuto.');
  }

  // Generar lectura
  const out = buildReading(positions, aspects, mode);
  renderReading(out);
}

// eventos
document.getElementById('findCoords').addEventListener('click', fetchCoords);
document.getElementById('getReading').addEventListener('click', getReading);
document.getElementById('toggleJson').addEventListener('change', () => {
  const jb = document.getElementById('jsonBox');
  jb.style.display = document.getElementById('toggleJson').checked ? 'block':'none';
});
</script>
</body>
</html>
